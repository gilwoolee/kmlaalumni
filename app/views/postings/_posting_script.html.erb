<script type="text/javascript">
  
  var page = 1;
  var numPages = 0;
  var loading = true;
  
  $('body').on('click', 'a.get_more_comments_link', function(event) {
    event.preventDefault();
    $.ajax({
      url: this.href,
      type: 'get',
      dataType: 'script'
    });
  });
  
  $('body').on('keypress', '.posting_comment_textarea', function (e) {
    if (e.which == 13) {
      e.preventDefault();
      $(this).closest('form').submit();
    }
  });
  
  function getNumPages() {
    $.ajax({
      url: '/postings/num_pages?' + <%= serialized_paginate_params %>,
      type: 'get',
      dataType: 'json',
      success: function(data) {
        numPages = data;
      }
    });
  }
    
  function appendNextPage() {
    $.ajax({
      url: '/postings/feed?' + <%= serialized_paginate_params %> + '&page=' + page,
      type: 'get',
      dataType: 'script',
      success: function() {
        loading = false;
      }
    });
  }
  
  function nearBottomOfPage() {
    return $(window).scrollTop() > $(document).height() - $(window).height() - 50;
  }
  
  function resetParams() {
    page = 1;
    numPages = 0;
  }
  
  function feedPostings() {
  
    getNumPages();
    appendNextPage();
    
    $(window).scroll(function(){
      if (page >= numPages || loading) {
        return;
      }

      if(nearBottomOfPage()) {
        loading=true;
        page++;
        appendNextPage();
      }
    });
  }
  
  $(document).ready(feedPostings());
</script>
